#!/usr/bin/env bash

set -o errexit -o nounset -o pipefail

# Use the Bazel binary specified by the integration test. Otherise, fall back 
# to bazel.
bazel="${BIT_BAZEL_BINARY:-bazel}"

# Generate Swift external deps and update build files
"${bazel}" run //:tidy

# rules_xcodeproj executes some Bazel commands. We need to tell it which
# version to use. Ideally, we would pass the path to the binary.  For now, we
# will count on the fact that we are using bazelisk.
USE_BAZEL_VERSION="$( "${bazel}" info release | cut -d ' ' -f 2 )"
export USE_BAZEL_VERSION

# Generate the Xcode project
"${bazel}" run //:xcodeproj

# Big clean. We perform the expunge to ensure that SPM commands work properly
# when Bazel is executed by Xcode projects generated by rules_xcodeproj.
# Related issue:
# https://github.com/MobileNativeFoundation/rules_xcodeproj/issues/2355
"${bazel}" clean --expunge

# Build the FooTests scheme in the Xcode project
xcodebuild -project App.xcodeproj -scheme FooTests

# Ensure that it builds and tests pass
"${bazel}" test //...

