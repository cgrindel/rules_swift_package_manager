#!/usr/bin/env bash

set -o errexit -o nounset -o pipefail

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" > /dev/null && pwd)"

# Generate Swift external deps and update build files
bazel run //:tidy

# Ensure that it builds and tests pass
bazel test //...

# Run MyExecutable target
output="$(bazel run //Sources/MyExecutable)"
[[ "${output}" =~ "Good morning, World!" ]] || (echo >&2 "Expected 'Good morning, World!'"; exit 1)

# Run old-style executable in my_local_package
output="$(bazel run @swiftpkg_my_local_package//:print-greeting)"
[[ "${output}" =~ "Good evening, Jim!" ]] || (echo >&2 "Expected 'Good evening, Jim!'"; exit 1)

# Buid and run the SwiftFormat alias
bazel run //:swiftformat -- --version
