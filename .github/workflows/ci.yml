# This file is processed by //tools/generate_ci_workflow.  Specifically, the
# matrix strategy sections for the integration test matrix jobs are updated with
# the values from //examples:json.
#
# Note:
# - Modification to values outside of the matrix strategy sections should 
#   persist.
# - Comments and custom formatting will be lost.
name: Continuous Integration
"on":
  pull_request:
    branches:
      - main
  schedule:
    - cron: 14 11 * * *
jobs:
  all_ci_tests:
    runs-on: ubuntu-20.04
    needs:
      - tidy_and_test_matrix
      - integration_test_matrix
    if: ${{ always() }}
    steps:
      - uses: cgrindel/gha_join_jobs@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
  integration_test_matrix:
    strategy:
      fail-fast: false
      matrix:
        include:
          - example: http_archive_ext_deps
            bazel_version: .bazelversion
            runner: macos-12
            enable_bzlmod: true
          - example: http_archive_ext_deps
            bazel_version: .bazelversion
            runner: macos-12
            enable_bzlmod: false
          - example: http_archive_ext_deps
            bazel_version: .bazelversion
            runner: ubuntu-22.04
            enable_bzlmod: true
          - example: http_archive_ext_deps
            bazel_version: .bazelversion
            runner: ubuntu-22.04
            enable_bzlmod: false
          - example: pkg_manifest_minimal
            bazel_version: .bazelversion
            runner: macos-12
            enable_bzlmod: true
          - example: pkg_manifest_minimal
            bazel_version: .bazelversion
            runner: ubuntu-22.04
            enable_bzlmod: true
          - example: soto_example
            bazel_version: .bazelversion
            runner: macos-12
            enable_bzlmod: true
          - example: soto_example
            bazel_version: .bazelversion
            runner: ubuntu-22.04
            enable_bzlmod: true
          - example: vapor_example
            bazel_version: .bazelversion
            runner: macos-12
            enable_bzlmod: true
          - example: vapor_example
            bazel_version: .bazelversion
            runner: macos-12
            enable_bzlmod: false
          - example: vapor_example
            bazel_version: .bazelversion
            runner: ubuntu-22.04
            enable_bzlmod: true
          - example: vapor_example
            bazel_version: .bazelversion
            runner: ubuntu-22.04
            enable_bzlmod: false
          - example: firebase_example
            bazel_version: .bazelversion
            runner: macos-12
            enable_bzlmod: true
          - example: interesting_deps
            bazel_version: .bazelversion
            runner: macos-12
            enable_bzlmod: true
          - example: ios_sim
            bazel_version: .bazelversion
            runner: macos-12
            enable_bzlmod: true
          - example: objc_code
            bazel_version: .bazelversion
            runner: macos-12
            enable_bzlmod: true
          - example: phone_number_kit
            bazel_version: .bazelversion
            runner: macos-12
            enable_bzlmod: true
          - example: xcmetrics_example
            bazel_version: .bazelversion
            runner: macos-12
            enable_bzlmod: true
    runs-on: ${{ matrix.runner }}
    env:
      CC: clang
    steps:
      - uses: actions/checkout@v3
      - uses: ./.github/actions/set_up_ubuntu
        if: ${{ startsWith(matrix.runner, 'ubuntu') }}
        with:
          repo_name: swift_bazel
          ubuntu_version: "22.04"
      - uses: ./.github/actions/set_up_macos
        if: ${{ startsWith(matrix.runner, 'macos') }}
        with:
          repo_name: swift_bazel
          xcode_version: 14.0.1
      - uses: ./.github/actions/test_example
        with:
          bazel_version: ${{ matrix.bazel_version }}
          example_name: ${{ matrix.example }}
  tidy_and_test_matrix:
    strategy:
      fail-fast: false
      matrix:
        runner:
          - macos-12
          - ubuntu-22.04
        enable_bzlmod:
          - true
          - false
    runs-on: ${{ matrix.runner }}
    env:
      CC: clang
    steps:
      - uses: actions/checkout@v3
      - uses: ./.github/actions/set_up_ubuntu
        if: ${{ startsWith(matrix.runner, 'ubuntu') }}
        with:
          repo_name: swift_bazel
          ubuntu_version: "22.04"
      - uses: ./.github/actions/set_up_macos
        if: ${{ startsWith(matrix.runner, 'macos') }}
        with:
          repo_name: swift_bazel
          xcode_version: 14.0.1
      - uses: ./.github/actions/configure_bzlmod
        with:
          enabled: ${{ matrix.enable_bzlmod }}
      - uses: ./.github/actions/tidy_and_test
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
